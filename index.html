<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divelun AI | Fitness Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-deep: #05070a;
            --primary: #3b82f6; 
            --primary-glow: rgba(59, 130, 246, 0.5);
            --accent: #00f2ff; 
            --glass-bg: rgba(13, 17, 23, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.08); 
            --text: #f8fafc; 
            --text-dim: #94a3b8; 
            --card-inner: rgba(255, 255, 255, 0.04);
            --nav-height: 75px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(0, 242, 255, 0.1) 0%, transparent 40%);
            color: var(--text); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
        }

        .container { 
            background: var(--glass-bg); 
            backdrop-filter: blur(30px); 
            -webkit-backdrop-filter: blur(30px);
            padding: 2.2rem; 
            border-radius: 2.5rem; 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            width: 100%; 
            max-width: 460px; 
            text-align: center; 
            position: relative; 
            z-index: 10;
        }

        h1, h2, h3 { margin: 0 0 0.5rem 0; font-weight: 800; letter-spacing: -0.02em; }
        h1 { font-size: 2.4rem; background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { font-size: 1.6rem; line-height: 1.2; }
        p { color: var(--text-dim); margin-bottom: 1.8rem; font-size: 0.95rem; line-height: 1.6; }

        button { 
            width: 100%; padding: 18px; 
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%); 
            color: white; border: none; border-radius: 1.2rem; 
            font-weight: 700; font-size: 1rem; cursor: pointer; margin-bottom: 1rem; 
            transition: all 0.3s; box-shadow: 0 8px 25px -5px var(--primary-glow);
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 12px 30px -5px var(--primary-glow); filter: brightness(1.1); }
        button.secondary { background: transparent; color: var(--text-dim); border: 1px solid var(--glass-border); box-shadow: none; }
        button.secondary:hover { color: #fff; background: rgba(255,255,255,0.05); }
        
        button.checkout-btn { background: #fff; color: #000; font-size: 1.1rem; box-shadow: 0 10px 30px -5px rgba(255,255,255,0.2); }

        input { 
            width: 100%; padding: 16px; background: rgba(0, 0, 0, 0.4); 
            border: 1px solid var(--glass-border); border-radius: 1rem; 
            color: #fff; margin-bottom: 1.2rem; transition: 0.3s;
        }

        /* MENU GLASSMORPHIC */
        .glass-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 420px; height: var(--nav-height);
            background: rgba(13, 17, 23, 0.85); backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            display: none; justify-content: space-around; align-items: center; z-index: 1000;
        }

        .nav-item { color: var(--text-dim); cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; font-weight: 600; }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

        /* TEST */
        .test-step { display: none; text-align: left; }
        .test-step.active { display: block; animation: slideIn 0.5s forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .option-card {
            background: var(--card-inner); border: 1px solid var(--glass-border);
            padding: 18px; border-radius: 1.2rem; margin-bottom: 12px;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 15px;
        }
        .option-card.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.15); color: #fff; }

        .progress-container { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 2.5rem; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(to right, var(--primary), var(--accent)); transition: 0.6s; }

        .view { display: none; opacity: 0; }
        .view.active { display: block; opacity: 1; }

        .loading { font-size: 0.85rem; color: var(--primary); margin-top: 15px; display: none; font-weight: 600; }
        .error { color: #ff4b4b; background: rgba(255, 75, 75, 0.1); padding: 12px; border-radius: 0.75rem; display: none; margin-top: 10px; }

        /* RUTINA */
        .routine-card { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 1.8rem; padding: 24px; text-align: left; margin-top: 1rem; }
        .exercise-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .exercise-name { font-weight: 600; color: #fff; }
        .exercise-meta { background: rgba(59, 130, 246, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

<nav id="main-nav" class="glass-nav">
    <div class="nav-item active" onclick="nav('view-dashboard')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>Hoy</span></div>
    <div class="nav-item" onclick="logout()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg><span>Salir</span></div>
</nav>

<div class="container">
    <script>const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCdrthB2s-Sb0rp8Fp9YNtznJWHwTbanvVBw9SHWYU-5RvZCWdTfQKWvnH4LaqeFQ-/exec";</script>

    <!-- BIENVENIDA -->
    <div id="view-welcome" class="view active">
        <div style="font-size: 4rem; margin-bottom: 10px;">‚ö°</div>
        <h1>Divelun AI</h1>
        <p>Entrenamiento inteligente basado en biometr√≠a avanzada.</p>
        <button onclick="nav('view-register')">Empezar ahora</button>
        <button class="secondary" onclick="nav('view-login')">Entrar</button>
    </div>

    <!-- REGISTRO -->
    <div id="view-register" class="view">
        <h2>Crear Cuenta</h2>
        <p>Tu progreso comienza aqu√≠.</p>
        <input type="email" id="reg-email" placeholder="Email">
        <input type="password" id="reg-pass" placeholder="Contrase√±a">
        <button id="btn-reg" onclick="handleRegister()">Registrar e ir al Test</button>
        <div id="reg-load" class="loading">Sincronizando con base de datos...</div>
        <div id="reg-msg" class="error"></div>
        <button class="secondary" onclick="nav('view-welcome')">Atr√°s</button>
    </div>

    <!-- LOGIN -->
    <div id="view-login" class="view">
        <h2>Bienvenido</h2>
        <p>Accede a tu cuenta.</p>
        <input type="email" id="login-email" placeholder="Email">
        <input type="password" id="login-pass" placeholder="Contrase√±a">
        <button onclick="handleLogin()">Entrar</button>
        <div id="login-load" class="loading">Verificando...</div>
        <div id="login-msg" class="error"></div>
        <button class="secondary" onclick="nav('view-welcome')">Atr√°s</button>
    </div>

    <!-- FITNESS TEST -->
    <div id="view-fitness-test" class="view">
        <div class="progress-container"><div id="test-progress" class="progress-bar"></div></div>
        
        <div class="test-step active" data-step="1">
            <h2>G√©nero</h2>
            <div class="option-card" onclick="selectOption(1, 'Masculino')">üë® Masculino</div>
            <div class="option-card" onclick="selectOption(1, 'Femenino')">üë© Femenino</div>
        </div>

        <div class="test-step" data-step="2">
            <h2>Objetivo</h2>
            <div class="option-card" onclick="selectOption(2, 'Grasa')">üî• Perder Grasa</div>
            <div class="option-card" onclick="selectOption(2, 'M√∫sculo')">üí™ Ganar M√∫sculo</div>
        </div>

        <div class="test-step" data-step="3">
            <h2>Frecuencia</h2>
            <div class="option-card" onclick="selectOption(3, '3 D√≠as')">üóìÔ∏è 3 D√≠as</div>
            <div class="option-card" onclick="selectOption(3, '5 D√≠as')">‚ö° 5 D√≠as</div>
        </div>

        <div class="test-step" data-step="4" style="text-align: center;">
            <div style="padding:40px 0;">
                <div style="width:50px; height:50px; border:4px solid var(--primary); border-top-color:transparent; border-radius:50%; animation:spin 1s infinite linear; margin:0 auto 20px;"></div>
                <h2>Generando Plan IA...</h2>
            </div>
        </div>
    </div>

    <!-- PAYWALL -->
    <div id="view-paywall" class="view">
        <h2>Plan Preparado</h2>
        <p>Tu rutina de <b id="res-freq"></b> est√° lista para ser activada.</p>
        <div class="routine-card" style="opacity: 0.5; pointer-events: none; filter: blur(2px);">
            <div class="exercise-item"><span>Ejercicio IA</span><span>4 x 12</span></div>
            <div class="exercise-item"><span>Carga Estimada</span><span>üîí</span></div>
        </div>
        <br>
        <a href="https://buy.stripe.com/test_aFa14p69Vgk53hjclXaZi01" target="_self" style="text-decoration: none;">
            <button class="checkout-btn">üí≥ Ir al Pago (Stripe)</button>
        </a>
        <p style="font-size:0.75rem; color:var(--text-dim);">Tras pagar, ser√°s redirigido para activar tu cuenta.</p>
    </div>

    <!-- √âXITO TRAS STRIPE -->
    <div id="view-success" class="view">
        <div style="font-size: 4rem; color: #10b981;">üéâ</div>
        <h2>¬°Pago Confirmado!</h2>
        <p>Stripe ha validado tu suscripci√≥n. Haz clic abajo para activar tu acceso en nuestra base de datos.</p>
        <button id="btn-activate" class="checkout-btn" style="background:#10b981; color:#fff;" onclick="activateAccount()">üöÄ Activar mi Plan IA</button>
        <div id="success-load" class="loading">Marcando como pagado en Google Sheets...</div>
    </div>

    <!-- DASHBOARD -->
    <div id="view-dashboard" class="view">
        <h2 id="dash-title">Tu Rutina IA</h2>
        <div class="routine-card">
            <div id="routine-list"></div>
        </div>
        <button style="margin-top:20px;" onclick="alert('¬°A darle!')">Comenzar Sesi√≥n</button>
    </div>
</div>

<script>
    let fitnessData = { gender: '', goal: '', freq: '' };
    let currentStep = 1;

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment_success') === 'true') {
            nav('view-success');
        }
    };

    function nav(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.getElementById('main-nav').style.display = (viewId === 'view-dashboard') ? 'flex' : 'none';
        document.querySelectorAll('.error, .loading').forEach(e => e.style.display = 'none');
    }

    async function postData(action, data) {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                body: JSON.stringify({ action: action, ...data })
            });
            return await response.json();
        } catch (error) { return { success: false, message: "Error de red." }; }
    }

    // --- FLUJO DE REGISTRO REAL ---
    async function handleRegister() {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        const load = document.getElementById('reg-load');
        const msg = document.getElementById('reg-msg');

        if(!email || !pass) { msg.innerText = "Completa los campos"; msg.style.display = 'block'; return; }
        
        load.style.display = 'block';
        msg.style.display = 'none';

        const res = await postData('register', { email, password: pass });
        load.style.display = 'none';

        if(res.success) {
            localStorage.setItem('tempUserEmail', email);
            nav('view-fitness-test');
        } else {
            msg.innerText = res.message;
            msg.style.display = 'block';
        }
    }

    // --- TEST ---
    function selectOption(step, val) {
        if(step === 1) fitnessData.gender = val;
        if(step === 2) fitnessData.goal = val;
        if(step === 3) fitnessData.freq = val;
        
        document.querySelector(`.test-step[data-step="${step}"]`).classList.remove('active');
        currentStep++;
        document.querySelector(`.test-step[data-step="${currentStep}"]`).classList.add('active');
        document.getElementById('test-progress').style.width = (currentStep * 25) + "%";

        if(currentStep === 4) {
            setTimeout(() => {
                document.getElementById('res-freq').innerText = fitnessData.freq;
                // Guardamos el test en local por si se refresca al volver de Stripe
                localStorage.setItem('tempFitness', JSON.stringify(fitnessData));
                nav('view-paywall');
            }, 2500);
        }
    }

    // --- ACTIVACI√ìN POST-PAGO ---
    async function activateAccount() {
        const email = localStorage.getItem('tempUserEmail');
        const load = document.getElementById('success-load');
        if(!email) { alert("Sesi√≥n perdida. Por favor inicia sesi√≥n."); nav('view-login'); return; }

        load.style.display = 'block';
        const res = await postData('payment_confirmation', { email: email });
        load.style.display = 'none';

        if(res.success) {
            // Limpiar URL y entrar
            window.history.replaceState({}, document.title, window.location.pathname);
            buildRoutine();
            nav('view-dashboard');
        } else {
            alert("Error al confirmar: " + res.message);
        }
    }

    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        const load = document.getElementById('login-load');
        const msg = document.getElementById('login-msg');

        load.style.display = 'block';
        const res = await postData('login', { email, password: pass });
        load.style.display = 'none';

        if(res.success) {
            buildRoutine();
            nav('view-dashboard');
        } else {
            msg.innerText = res.message;
            msg.style.display = 'block';
        }
    }

    function buildRoutine() {
        const list = document.getElementById('routine-list');
        const data = JSON.parse(localStorage.getItem('tempFitness')) || {goal: 'Fitness'};
        list.innerHTML = `
            <div class="exercise-item"><span>Press de Banca</span><span>4 x 10</span></div>
            <div class="exercise-item"><span>Sentadillas</span><span>4 x 12</span></div>
            <div class="exercise-item"><span>Remo con Barra</span><span>3 x 12</span></div>
            <div class="exercise-item"><span>Plancha IA</span><span>3 x 1 min</span></div>
        `;
    }

    function logout() { localStorage.clear(); location.reload(); }
</script>

<style> @keyframes spin { to { transform: rotate(360deg); } } </style>
</body>
</html>
