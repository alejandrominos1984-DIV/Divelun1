<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso Exclusivo</title>
    <style>
        /* ESTILOS (Mismos que antes + Animaci√≥n de √©xito) */
        :root { --primary: #6366f1; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: var(--card); padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1, h2 { margin-bottom: 1.5rem; color: #111827; }
        input { width: 100%; padding: 12px; margin-bottom: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: var(--primary); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; margin-bottom: 0.5rem; }
        button:hover { background-color: #4f46e5; }
        button.secondary { background-color: transparent; color: var(--primary); border: 1px solid var(--primary); }
        button.stripe-btn { background-color: #635bff; }
        button.success-btn { background-color: #10b981; font-size: 1.1rem; } /* Bot√≥n Comencemos verde */
        
        .view { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .view.active { display: block; opacity: 1; }
        .error { color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; display: none; }
        .loading { font-size: 0.875rem; color: #6b7280; margin-top: 10px; display: none; }
        
        /* Icono de Check animado */
        .check-icon { font-size: 50px; color: #10b981; margin-bottom: 20px; display: block; }
    </style>
</head>
<body>

<div class="container">
    
    <script>
        // ==========================================
        // PEGA AQU√ç TU URL DE APPS SCRIPT
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCdrthB2s-Sb0rp8Fp9YNtznJWHwTbanvVBw9SHWYU-5RvZCWdTfQKWvnH4LaqeFQ-/exec";
    </script>

    <div id="view-welcome" class="view active">
        <h1>Bienvenido</h1>
        <p>Accede a contenido exclusivo y herramientas premium.</p>
        <button onclick="nav('view-login')">Iniciar Sesi√≥n</button>
        <button class="secondary" onclick="nav('view-register')">Crear Cuenta</button>
    </div>

    <div id="view-register" class="view">
        <h2>Crear Cuenta</h2>
        <input type="email" id="reg-email" placeholder="Tu correo electr√≥nico">
        <input type="password" id="reg-pass" placeholder="Crea una contrase√±a">
        <button onclick="handleRegister()">Registrarme y Pagar</button>
        <button class="secondary" onclick="nav('view-welcome')">Volver</button>
        <div id="reg-msg" class="error"></div>
        <div id="reg-load" class="loading">Procesando registro...</div>
    </div>

    <div id="view-payment" class="view">
        <h2>Casi listo...</h2>
        <p>Cuenta creada. Haz clic abajo para completar tu suscripci√≥n segura en Stripe.</p>
        
        <a href="https://buy.stripe.com/test_aFa14p69Vgk53hjclXaZi01" target="_self" style="text-decoration: none;">
            <button class="stripe-btn">üí≥ Pagar Membres√≠a Ahora</button>
        </a>
        
        <p style="font-size: 0.8rem; color: #666; margin-top: 20px;">
            Ser√°s redirigido aqu√≠ autom√°ticamente despu√©s del pago.
        </p>
    </div>

    <div id="view-success" class="view">
        <div class="check-icon">‚ú®</div>
        <h2>¬°Pago Realizado!</h2>
        <p>Tu suscripci√≥n ha sido procesada. Solo falta activar tu cuenta.</p>
        
        <button class="success-btn" onclick="activateAccount()">üöÄ Comencemos</button>
        
        <div id="success-load" class="loading">Cargando tu contenido...</div>
    </div>

    <div id="view-login" class="view">
        <h2>Iniciar Sesi√≥n</h2>
        <input type="email" id="login-email" placeholder="Correo electr√≥nico">
        <input type="password" id="login-pass" placeholder="Contrase√±a">
        <button onclick="handleLogin()">Entrar</button>
        <button class="secondary" onclick="nav('view-welcome')">Volver</button>
        <div id="login-msg" class="error"></div>
        <div id="login-load" class="loading">Verificando credenciales...</div>
    </div>

    <div id="view-dashboard" class="view">
        <h2>Dashboard</h2>
        <p>¬°Hola! Tu estatus es <strong style="color: green;">PAID</strong>.</p>
        <div style="text-align: left; background: #f9fafb; padding: 10px; border-radius: 5px;">
            <p>Bienvenido al √°rea de miembros.</p>
            <ul>
                <li>Contenido Premium 1</li>
                <li>Contenido Premium 2</li>
            </ul>
        </div>
        <br>
        <button class="secondary" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
</div>

<script>
    // Al cargar la p√°gina, verificamos si viene de Stripe
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        // Si la URL tiene ?payment_success=true
        if (urlParams.get('payment_success') === 'true') {
            nav('view-success'); // Mostrar pantalla "Comencemos" directamente
        }
    };

    function nav(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.querySelectorAll('.error').forEach(el => el.style.display = 'none');
    }

    async function postData(action, data) {
        const payload = { action: action, ...data };
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                body: JSON.stringify(payload)
            });
            return await response.json();
        } catch (error) {
            return { success: false, message: "Error de conexi√≥n." };
        }
    }

    // REGISTRO
    async function handleRegister() {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        const loader = document.getElementById('reg-load');
        const msg = document.getElementById('reg-msg');

        if(!email || !pass) { msg.innerText = "Completa todos los campos"; msg.style.display = 'block'; return; }
        
        loader.style.display = 'block';
        
        const res = await postData('register', { email, password: pass });
        loader.style.display = 'none';
        
        if (res.success) {
            // TRUCO: Guardamos el email en el navegador para recordarlo al volver de Stripe
            localStorage.setItem('tempUserEmail', email); 
            nav('view-payment');
        } else {
            msg.innerText = res.message; msg.style.display = 'block';
        }
    }

    // ACTIVACI√ìN (Bot√≥n Comencemos)
    async function activateAccount() {
        // Recuperamos el email que guardamos antes de ir a Stripe
        const savedEmail = localStorage.getItem('tempUserEmail');
        const loader = document.getElementById('success-load');

        if(!savedEmail) {
            alert("No se encontr√≥ el email de registro. Por favor inicia sesi√≥n.");
            nav('view-login');
            return;
        }

        loader.style.display = 'block'; // Dice: "Cargando tu contenido..."

        // Llamamos al script para confirmar pago
        const res = await postData('payment_confirmation', { email: savedEmail });
        
        if(res.success) {
            // Limpiamos la URL para quitar ?payment_success=true
            window.history.replaceState({}, document.title, window.location.pathname);
            // Limpiamos storage
            localStorage.removeItem('tempUserEmail');
            // Vamos directo al Dashboard
            nav('view-dashboard');
        } else {
            loader.style.display = 'none';
            alert("Error: " + res.message);
        }
    }

    // LOGIN
    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        const loader = document.getElementById('login-load');
        const msg = document.getElementById('login-msg');

        loader.style.display = 'block';
        const res = await postData('login', { email, password: pass });
        loader.style.display = 'none';

        if (res.success) {
            nav('view-dashboard');
        } else {
            msg.innerText = res.message; msg.style.display = 'block';
        }
    }

    function logout() {
        location.href = window.location.pathname; // Recargar p√°gina limpia
    }
</script>

</body>
</html>

