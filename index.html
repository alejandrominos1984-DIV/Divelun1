<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Video Pro para Clientes</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Estilos personalizados para los controles */
        .tool-group { @apply flex flex-col gap-2 mb-4 p-3 bg-gray-800 rounded-lg; }
        .tool-label { @apply text-xs text-gray-400 uppercase font-semibold; }
        .btn-pro { @apply bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded transition flex items-center justify-center gap-2 font-medium; }
        .input-pro { @apply bg-gray-700 text-white rounded p-2 border border-gray-600 focus:border-indigo-500 outline-none; }
        
        /* Ajuste para que el canvas sea responsive dentro de su contenedor */
        #canvas-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            overflow: hidden;
        }
        .canvas-container { 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden font-['Roboto']">

    <header class="bg-gray-800 p-3 border-b border-gray-700 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-video text-indigo-500 text-xl"></i>
            <h1 class="text-lg font-bold">Video Creator <span class="text-indigo-400">Pro</span></h1>
        </div>
        <div class="flex gap-3">
             <label class="btn-pro bg-gray-700 hover:bg-gray-600 cursor-pointer">
                <i class="fa-solid fa-upload"></i> Subir Video Base
                <input type="file" id="videoLoader" class="hidden" accept="video/mp4,video/webm">
            </label>
            <button id="recordBtn" class="btn-pro bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa-solid fa-circle text-red-500 mr-1" id="recIcon"></i> <span id="recText">Grabar y Descargar</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">

        <div class="w-80 bg-gray-850 p-4 overflow-y-auto border-r border-gray-800 scrollbar-thin">
            
            <div class="tool-group">
                <span class="tool-label">Agregar Elementos</span>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="addText()" class="btn-pro bg-gray-700"><i class="fa-solid fa-font"></i> Texto</button>
                    <button onclick="addRect()" class="btn-pro bg-gray-700"><i class="fa-solid fa-square"></i> Rect√°ngulo</button>
                </div>
                <button onclick="addEmoji()" class="btn-pro bg-gray-700 mt-2"><i class="fa-regular fa-face-smile"></i> Emoji üòÄ</button>
            </div>

            <div class="tool-group bg-indigo-900/30 border border-indigo-500/30">
                 <span class="tool-label text-indigo-300">‚ú® Plantillas R√°pidas</span>
                 <p class="text-xs text-gray-400 mb-2">Estilo TikTok/Reels (Click para a√±adir)</p>
                 
                 <button onclick="addTemplateTitle()" class="bg-white p-2 rounded mb-2 text-left flex items-center shadow-sm hover:scale-105 transition">
                     <div class="bg-black text-white p-1 rounded mr-2 text-xs">T√çTULO</div>
                     <span class="text-black text-sm font-bold">Fondo blanco, texto negrita</span>
                 </button>

                 <button onclick="addTemplateList()" class="bg-blue-500 p-2 rounded text-left flex items-center shadow-sm hover:scale-105 transition w-full">
                    <i class="fa-solid fa-broom text-white mr-2"></i>
                    <span class="text-white text-sm font-bold">Etiqueta Azul + Icono</span>
                </button>
            </div>

            <div id="propertiesPanel" class="tool-group opacity-50 pointer-events-none transition-opacity">
                <span class="tool-label text-indigo-400">Propiedades de Selecci√≥n</span>
                
                <div class="flex items-center justify-between mt-2 bg-gray-700 p-2 rounded">
                    <span class="text-sm">Color:</span>
                    <input type="color" id="colorPicker" class="h-8 w-14 cursor-pointer bg-transparent rounded" value="#ffffff">
                </div>

                <div id="textControls" class="hidden flex flex-col gap-3 mt-3 pt-3 border-t border-gray-700">
                     <div>
                        <span class="text-sm block mb-1">Tipograf√≠a:</span>
                        <select id="fontFamily" class="input-pro w-full">
                            <option value="Arial">Arial (B√°sica)</option>
                            <option value="Roboto" selected>Roboto (Moderna)</option>
                            <option value="Montserrat">Montserrat (Geom√©trica)</option>
                            <option value="Playfair Display">Playfair (Elegante)</option>
                        </select>
                    </div>
                    
                     <div>
                        <span class="text-sm block mb-1">Grosor:</span>
                         <select id="fontWeight" class="input-pro w-full">
                            <option value="normal">Normal</option>
                            <option value="bold">Negrita (Bold)</option>
                        </select>
                    </div>
                </div>
            </div>

            <button onclick="deleteActive()" class="btn-pro bg-red-600/80 hover:bg-red-600 mt-auto w-full">
                <i class="fa-solid fa-trash"></i> Eliminar Seleccionado (Supr)
            </button>
        </div>

        <div id="canvas-wrapper" class="flex-1 bg-black relative">
            <canvas id="c"></canvas>
            
            <video id="hiddenVideoElement" style="display: none;" playsinline crossOrigin="anonymous"></video>
            
            <div id="recordingOverlay" class="absolute top-4 right-4 bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center hidden animate-pulse z-20">
                <span>‚óè GRABANDO... NO CIERRES ESTA PESTA√ëA</span>
            </div>
             <div id="videoPlaceholder" class="absolute text-gray-500 flex flex-col items-center pointer-events-none">
                <i class="fa-solid fa-film text-5xl mb-4 opacity-50"></i>
                <p>Sube un video para comenzar</p>
             </div>
        </div>
    </div>


    <script>
        // --- CONFIGURACI√ìN INICIAL ---
        const videoElement = document.getElementById('hiddenVideoElement');
        const recordBtn = document.getElementById('recordBtn');
        const recText = document.getElementById('recText');
        const recordingOverlay = document.getElementById('recordingOverlay');
        const propertiesPanel = document.getElementById('propertiesPanel');
        const textControls = document.getElementById('textControls');
        const videoPlaceholder = document.getElementById('videoPlaceholder');

        // Variables globales de estado
        let isVideoLoaded = false;
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let fabricVideoObj; // Referencia al objeto de video en Fabric

        // Inicializar Canvas
        // Usamos una resoluci√≥n base alta (ej: Full HD vertical) para que la exportaci√≥n sea de calidad.
        // El CSS se encarga de que se vea peque√±o en la pantalla.
        const canvasResolution = { width: 720, height: 1280 }; 
        const canvas = new fabric.Canvas('c', {
            width: canvasResolution.width,
            height: canvasResolution.height,
            backgroundColor: '#111',
            preserveObjectStacking: true // Importante para que el texto siempre quede sobre el video
        });

        // --- 1. MANEJO DEL VIDEO DE FONDO ---

        document.getElementById('videoLoader').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            videoElement.src = url;

            videoElement.onloadedmetadata = function() {
                // Ajustar el tama√±o del canvas a la relaci√≥n de aspecto del video subido
                const videoRatio = videoElement.videoWidth / videoElement.videoHeight;
                const newHeight = canvas.getWidth() / videoRatio;
                canvas.setHeight(newHeight);

                videoPlaceholder.classList.add('hidden');
                recordBtn.disabled = false;

                // Crear el objeto de video de Fabric
                fabricVideoObj = new fabric.Image(videoElement, {
                    left: 0,
                    top: 0,
                    scaleX: canvas.getWidth() / videoElement.videoWidth,
                    scaleY: canvas.getHeight() / videoElement.videoHeight,
                    selectable: false, // El fondo no se debe poder mover
                    evented: false,
                });
                
                // Insertar al fondo (√≠ndice 0)
                canvas.insertAt(fabricVideoObj, 0, true);
                isVideoLoaded = true;

                // IMPORTANTE: Bucle de renderizado.
                // Fabric.js necesita redibujar el canvas cada vez que el video avanza un frame.
                fabric.util.requestAnimFrame(function renderLoop() {
                    if (isVideoLoaded) {
                        canvas.renderAll();
                        fabric.util.requestAnimFrame(renderLoop);
                    }
                });
            };
        });

        // --- 2. HERRAMIENTAS DE EDICI√ìN ---

        function addText() {
            const text = new fabric.IText('Doble clic para editar', {
                left: canvas.getWidth() / 2,
                top: canvas.getHeight() / 2,
                originX: 'center',
                originY: 'center',
                fontFamily: 'Roboto',
                fill: '#ffffff',
                fontSize: 40,
                fontWeight: 'bold',
                shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 5, offsetX: 2, offsetY: 2 })
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function addEmoji() {
            const text = new fabric.IText('üòéüî•üöÄ', {
                left: canvas.getWidth() / 2,
                top: canvas.getHeight() / 2,
                originX: 'center',
                originY: 'center',
                fontSize: 60,
                selectable: true
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function addRect() {
            const rect = new fabric.Rect({
                left: canvas.getWidth() / 2,
                top: canvas.getHeight() / 2,
                originX: 'center',
                originY: 'center',
                fill: '#4f46e5', // Indigo
                width: 200,
                height: 100,
                rx: 10, // Bordes redondeados
                ry: 10
            });
            canvas.add(rect);
            canvas.setActiveObject(rect);
        }

        // --- 3. PLANTILLAS (ESTILO TIKTOK/REELS) ---

        // Plantilla 1: T√≠tulo blanco estilo "How to..." (Imagen 1)
        function addTemplateTitle() {
            const bgBox = new fabric.Rect({
                fill: '#ffffff',
                width: 500,
                height: 80,
                rx: 15, ry: 15,
                originX: 'center', originY: 'center'
            });
            
            const text = new fabric.IText('How to write a Business Email üíª', {
                fontFamily: 'Montserrat',
                fontSize: 28,
                fill: '#000000',
                fontWeight: 'bold',
                originX: 'center', originY: 'center',
                top: 2 // peque√±o ajuste visual
            });

            // Agrupamos para que se muevan juntos
            const group = new fabric.Group([bgBox, text], {
                left: canvas.getWidth() / 2,
                top: canvas.getHeight() / 3,
                originX: 'center',
                originY: 'center',
            });
            
            canvas.add(group);
            canvas.setActiveObject(group);
        }

        // Plantilla 2: Etiqueta azul con icono (Imagen 2)
        function addTemplateList() {
             // Usamos FontAwesome como texto para el icono (truco r√°pido)
            const icon = new fabric.IText('\uf51a', { // C√≥digo del icono de escoba
                fontFamily: 'Font Awesome 6 Free',
                fontWeight: '900',
                fontSize: 30,
                fill: '#ffffff',
                left: -100, top: 0,
                originY: 'center'
            });

            const text = new fabric.IText('Cleaning Vocabulary', {
                fontFamily: 'Roboto',
                fontSize: 24,
                fill: '#ffffff',
                fontWeight: 'bold',
                left: -60, top: 0,
                originY: 'center'
            });

            const bgBox = new fabric.Rect({
                fill: '#3b82f6', // Azul
                width: text.width + icon.width + 60, // Ancho din√°mico
                height: 60,
                rx: 30, ry: 30, // Completamente redondeado
                originX: 'center', originY: 'center'
            });

            // Necesitamos recentrar los elementos dentro del grupo
            icon.set({ left: -bgBox.width/2 + 20 });
            text.set({ left: icon.left + icon.width + 15 });

            const group = new fabric.Group([bgBox, icon, text], {
                left: canvas.getWidth() / 2,
                top: canvas.getHeight() / 2,
            });
            
            canvas.add(group);
            canvas.setActiveObject(group);
        }

        // --- 4. MANEJO DE PROPIEDADES Y EVENTOS ---

        // Eliminar objeto
        function deleteActive() {
            const active = canvas.getActiveObject();
            if(active && active !== fabricVideoObj) canvas.remove(active);
        }
        document.addEventListener('keydown', (e) => { if(e.key === 'Delete') deleteActive(); });

        // Actualizar el panel de propiedades al seleccionar
        canvas.on('selection:created', updatePanel);
        canvas.on('selection:updated', updatePanel);
        canvas.on('selection:cleared', () => {
            propertiesPanel.classList.add('opacity-50', 'pointer-events-none');
        });

        function updatePanel() {
            const active = canvas.getActiveObject();
            if (!active) return;

            propertiesPanel.classList.remove('opacity-50', 'pointer-events-none');

            // Mostrar/ocultar controles espec√≠ficos de texto
            if (active.type === 'i-text' || active.type === 'textbox') {
                textControls.classList.remove('hidden');
                document.getElementById('fontFamily').value = active.fontFamily;
                document.getElementById('fontWeight').value = active.fontWeight;
                document.getElementById('colorPicker').value = active.fill;
            } else {
                textControls.classList.add('hidden');
                document.getElementById('colorPicker').value = active.fill || '#ffffff';
            }
            
            // Si es un grupo, intentamos obtener el color del primer elemento (la caja de fondo)
             if(active.type === 'group'){
                textControls.classList.add('hidden');
                const bgItem = active.getObjects().find(o => o.type === 'rect');
                if(bgItem) document.getElementById('colorPicker').value = bgItem.fill;
            }
        }

        // Listeners para los cambios de propiedades
        document.getElementById('colorPicker').addEventListener('input', function(e) {
            const active = canvas.getActiveObject();
            if (!active) return;
            
            if (active.type === 'i-text' || active.type === 'textbox') {
                active.set('fill', e.target.value);
            } else if(active.type === 'group') {
                 // Si es grupo, cambiamos el fondo (rect) y el texto a blanco/negro seg√∫n contraste
                 active.getObjects().forEach(obj => {
                    if(obj.type === 'rect') obj.set('fill', e.target.value);
                    // L√≥gica simple para cambiar texto a blanco o negro seg√∫n el fondo
                    /* Si el usuario quiere control total, es mejor no usar grupos,
                       pero para plantillas r√°pidas esto ayuda */
                 });
            } else {
                active.set('fill', e.target.value);
            }
            canvas.renderAll();
        });

        document.getElementById('fontFamily').addEventListener('change', function(e) {
            const active = canvas.getActiveObject();
            if (active && (active.type === 'i-text' || active.type === 'textbox')) {
                active.set('fontFamily', e.target.value);
                canvas.renderAll();
            }
        });

        document.getElementById('fontWeight').addEventListener('change', function(e) {
            const active = canvas.getActiveObject();
            if (active && (active.type === 'i-text' || active.type === 'textbox')) {
                active.set('fontWeight', e.target.value);
                canvas.renderAll();
            }
        });


        // --- 5. GRABACI√ìN Y EXPORTACI√ìN (LA PARTE COMPLEJA) ---

        recordBtn.addEventListener('click', toggleRecording);

        async function toggleRecording() {
            if (!isVideoLoaded) return;

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                // 1. Preparar la UI
                isRecording = true;
                recText.innerText = "Detener y Guardar";
                recordingOverlay.classList.remove('hidden');
                recordBtn.classList.replace('bg-green-600', 'bg-red-600');
                recordBtn.classList.replace('hover:bg-green-700', 'hover:bg-red-700');
                canvas.discardActiveObject(); // Deseleccionar para que no salgan los bordes en el video
                canvas.renderAll();

                // 2. Reiniciar el video para grabar desde el principio
                videoElement.currentTime = 0;
                await videoElement.play();

                // 3. Capturar el stream de VIDEO del canvas (30 FPS)
                const canvasStream = canvas.getElement().captureStream(30);

                // 4. Capturar el stream de AUDIO del elemento de video
                // Esto es necesario para que el video final tenga sonido.
                const audioContext = new AudioContext();
                const audioSource = audioContext.createMediaElementSource(videoElement);
                const audioDestination = audioContext.createMediaStreamDestination();
                audioSource.connect(audioDestination);
                // Conectar tambi√©n a la salida normal para que el usuario lo escuche mientras graba
                audioSource.connect(audioContext.destination); 
                const audioStream = audioDestination.stream;

                // 5. Combinar Video y Audio en un solo stream
                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...audioStream.getAudioTracks()
                ]);

                // 6. Iniciar MediaRecorder
                recordedChunks = [];
                // Intentamos usar codecs modernos si est√°n disponibles
                let options = { mimeType: 'video/webm;codecs=vp9,opus' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'video/webm' }; // Fallback
                }
                
                mediaRecorder = new MediaRecorder(combinedStream, options);

                mediaRecorder.ondataavailable = function(e) {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = downloadVideo;

                mediaRecorder.start();

                // Detener autom√°ticamente cuando termine el video
                videoElement.addEventListener('ended', stopRecording, { once: true });

            } catch (err) {
                console.error("Error al iniciar grabaci√≥n:", err);
                alert("No se pudo iniciar la grabaci√≥n de pantalla. Aseg√∫rate de usar un navegador moderno (Chrome/Firefox en PC es lo ideal).");
                stopRecording();
            }
        }

        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;
            mediaRecorder.stop();
            videoElement.pause();
            
            // Restaurar UI
            recText.innerText = "Procesando...";
            recordingOverlay.classList.add('hidden');
            recordBtn.disabled = true;
        }

        function downloadVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'mi-video-editado.webm';
            document.body.appendChild(a);
            a.click();
            
            // Limpieza final
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                // Restaurar bot√≥n
                recText.innerText = "Grabar y Descargar";
                recordBtn.classList.replace('bg-red-600', 'bg-green-600');
                recordBtn.classList.replace('hover:bg-red-700', 'hover:bg-green-700');
                recordBtn.disabled = false;
            }, 100);
        }

    </script>
</body>
</html>
