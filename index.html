<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor Social M贸vil</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Bloquear scroll para sensaci贸n de App Nativa */
        body { overscroll-behavior: none; touch-action: none; }
        
        /* rea del Canvas */
        .canvas-area {
            height: calc(100vh - 140px); /* Restamos header y footer */
            width: 100vw;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Overlay de Carga (Renderizado) */
        .loading-overlay {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
            z-index: 50;
        }

        /* Botones de herramientas */
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #9ca3af;
            gap: 4px;
        }
        .nav-btn.active { color: #818cf8; }
        .nav-btn i { font-size: 1.25rem; margin-bottom: 2px; }

        /* Estilo para inputs de rango personalizados */
        input[type=range] { accent-color: #6366f1; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen w-screen flex flex-col overflow-hidden font-['Roboto']">

    <header class="h-14 bg-gray-800 flex justify-between items-center px-4 border-b border-gray-700 z-10">
        <div class="font-bold text-lg text-indigo-400">Social<span class="text-white">Maker</span></div>
        <button onclick="startExport()" id="saveBtn" class="bg-indigo-600 px-4 py-1.5 rounded-full text-sm font-bold opacity-50 cursor-not-allowed" disabled>
            Guardar
        </button>
    </header>

    <main class="canvas-area relative bg-gray-950">
        
        <div id="welcomeScreen" class="absolute flex flex-col items-center justify-center text-center p-6 z-10">
            <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4">
                <i class="fa-solid fa-cloud-arrow-up text-2xl text-indigo-400"></i>
            </div>
            <h2 class="text-xl font-bold mb-2">Sube tu Video</h2>
            <p class="text-gray-400 text-sm mb-6">Duraci贸n: 5s a 40s.</p>
            
            <label class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold w-full shadow-lg active:scale-95 transition cursor-pointer">
                Seleccionar Video
                <input type="file" id="videoInput" class="hidden" accept="video/mp4,video/webm">
            </label>
        </div>

        <canvas id="c" style="display:none;"></canvas>
        
        <video id="sourceVideo" class="hidden" playsinline muted crossOrigin="anonymous"></video>
    </main>

    <footer id="toolsFooter" class="h-24 bg-gray-800 border-t border-gray-700 hidden flex-col">
        
        <div id="subMenu" class="h-10 bg-gray-900 flex items-center px-4 gap-4 overflow-x-auto hidden">
            </div>

        <div class="flex-1 flex justify-around items-center px-2">
            <button onclick="addSimpleText()" class="nav-btn">
                <i class="fa-solid fa-font"></i> Texto
            </button>
            <button onclick="addTemplate1()" class="nav-btn">
                <i class="fa-solid fa-layer-group"></i> Plantilla
            </button>
            <button onclick="addEmoji()" class="nav-btn">
                <i class="fa-regular fa-face-smile"></i> Emoji
            </button>
            <button onclick="deleteObject()" class="nav-btn text-red-400">
                <i class="fa-solid fa-trash"></i> Borrar
            </button>
        </div>
    </footer>

    <div id="loadingOverlay" class="loading-overlay fixed inset-0 flex flex-col items-center justify-center hidden">
        <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h3 class="text-xl font-bold">Exportando Video...</h3>
        <p class="text-gray-400 text-sm mt-2">No cierres esta ventana</p>
        <div class="w-64 bg-gray-700 h-2 rounded-full mt-4 overflow-hidden">
            <div id="progressBar" class="bg-indigo-500 h-full w-0 transition-all duration-300"></div>
        </div>
        <p id="progressText" class="text-xs text-gray-400 mt-2">0%</p>
    </div>

    <div id="editPanel" class="fixed bottom-0 left-0 right-0 bg-gray-800 p-4 rounded-t-2xl transform translate-y-full transition-transform duration-300 z-40 shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <span class="font-bold text-sm text-gray-400">EDITAR ESTILO</span>
            <button onclick="closeEditPanel()" class="text-gray-400"><i class="fa-solid fa-times"></i></button>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="text-xs text-gray-500 mb-1 block">Color Texto</label>
                <input type="color" id="textColor" class="w-full h-10 rounded bg-gray-700 border-none">
            </div>
            <div>
                <label class="text-xs text-gray-500 mb-1 block">Fondo Caja</label>
                <input type="color" id="bgColor" class="w-full h-10 rounded bg-gray-700 border-none">
            </div>
        </div>
        
        <div class="mt-4">
            <label class="text-xs text-gray-500 mb-1 block">Tama帽o</label>
            <input type="range" id="sizeSlider" min="20" max="100" class="w-full">
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACIN ---
        const canvas = new fabric.Canvas('c', { selection: false }); // Selecci贸n manual
        const videoEl = document.getElementById('sourceVideo');
        const saveBtn = document.getElementById('saveBtn');
        let fabricVideo;
        let isProcessing = false;

        // --- 2. LOGICA DE SUBIDA Y VALIDACIN ---
        document.getElementById('videoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            // Paso 1: Cargar metadata para validar duraci贸n
            const tempUrl = URL.createObjectURL(file);
            const tempVideo = document.createElement('video');
            tempVideo.preload = 'metadata';
            tempVideo.src = tempUrl;
            
            tempVideo.onloadedmetadata = function() {
                const duration = tempVideo.duration;
                window.URL.revokeObjectURL(tempUrl);

                // VALIDACIN DE TIEMPO (5s - 40s)
                if(duration < 5) {
                    alert("El video es muy corto. M铆nimo 5 segundos.");
                    return;
                }
                if(duration > 40) {
                    alert("El video es muy largo. M谩ximo 40 segundos.");
                    return;
                }

                // Si pasa, cargamos de verdad
                loadVideoToCanvas(file);
            }
        });

        function loadVideoToCanvas(file) {
            const url = URL.createObjectURL(file);
            videoEl.src = url;
            
            videoEl.onloadeddata = function() {
                // Configurar tama帽o del canvas basado en el video
                // pero ajustado a la pantalla del m贸vil
                const screenW = document.querySelector('.canvas-area').clientWidth;
                const screenH = document.querySelector('.canvas-area').clientHeight;
                
                // Calculamos aspect ratio para que "quepa" sin deformarse (contain)
                const videoRatio = videoEl.videoWidth / videoEl.videoHeight;
                
                let renderW = screenW;
                let renderH = screenW / videoRatio;

                if(renderH > screenH) {
                    renderH = screenH;
                    renderW = screenH * videoRatio;
                }

                canvas.setWidth(renderW);
                canvas.setHeight(renderH);
                
                // Crear objeto Fabric
                fabricVideo = new fabric.Image(videoEl, {
                    left: 0, top: 0,
                    scaleX: renderW / videoEl.videoWidth,
                    scaleY: renderH / videoEl.videoHeight,
                    selectable: false,
                    evented: false
                });

                canvas.add(fabricVideo);
                canvas.sendToBack(fabricVideo);

                // UI Updates
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('c').style.display = 'block';
                document.getElementById('toolsFooter').classList.replace('hidden', 'flex');
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                // Render Loop para mostrar el frame actual
                fabric.util.requestAnimFrame(function render() {
                    canvas.renderAll();
                    if(!isProcessing) fabric.util.requestAnimFrame(render);
                });
            };
        }

        // --- 3. HERRAMIENTAS (TEXTO Y PLANTILLAS) ---

        function addSimpleText() {
            const text = new fabric.IText('Toca 2 veces', {
                left: canvas.width / 2,
                top: canvas.height / 2,
                originX: 'center', originY: 'center',
                fontFamily: 'Montserrat',
                fill: '#ffffff',
                fontSize: 40,
                fontWeight: 'bold',
                shadow: '0px 2px 4px rgba(0,0,0,0.5)'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        // Plantilla 1: Caja de fondo con texto (Estilo Insta/TikTok)
        function addTemplate1() {
            const text = new fabric.IText('TU TEXTO', {
                fontFamily: 'Montserrat',
                fontSize: 30,
                fill: '#000000',
                originX: 'center', originY: 'center',
                top: 0, left: 0
            });

            const rect = new fabric.Rect({
                fill: '#ffffff',
                width: 300,
                height: 60,
                rx: 10, ry: 10,
                originX: 'center', originY: 'center'
            });

            const group = new fabric.Group([rect, text], {
                left: canvas.width / 2,
                top: canvas.height / 2,
            });

            canvas.add(group);
            canvas.setActiveObject(group);
        }

        function addEmoji() {
            const text = new fabric.IText('', {
                fontSize: 60,
                left: canvas.width / 2, top: canvas.height / 2,
                originX: 'center', originY: 'center'
            });
            canvas.add(text);
        }

        function deleteObject() {
            const active = canvas.getActiveObject();
            if(active) canvas.remove(active);
            closeEditPanel();
        }

        // --- 4. PANEL DE EDICIN (UX MVIL) ---
        
        canvas.on('selection:created', openEditPanel);
        canvas.on('selection:updated', openEditPanel);
        canvas.on('selection:cleared', closeEditPanel);

        function openEditPanel() {
            const active = canvas.getActiveObject();
            if(!active) return;
            
            document.getElementById('editPanel').classList.remove('translate-y-full');
            
            // Cargar valores actuales
            // (Logica simplificada para demo)
            if(active.fill) document.getElementById('textColor').value = active.fill;
        }

        function closeEditPanel() {
            document.getElementById('editPanel').classList.add('translate-y-full');
        }

        // Eventos del panel de edici贸n
        document.getElementById('textColor').addEventListener('input', (e) => {
            const active = canvas.getActiveObject();
            if(active) {
                // Si es grupo, buscamos texto
                if(active.type === 'group') {
                    active.getObjects().forEach(o => {
                        if(o.type === 'i-text') o.set('fill', e.target.value);
                    });
                } else {
                    active.set('fill', e.target.value);
                }
                canvas.renderAll();
            }
        });

        document.getElementById('bgColor').addEventListener('input', (e) => {
            const active = canvas.getActiveObject();
            if(active && active.type === 'group') {
                active.getObjects().forEach(o => {
                    if(o.type === 'rect') o.set('fill', e.target.value);
                });
                canvas.renderAll();
            }
        });
        
        document.getElementById('sizeSlider').addEventListener('input', (e) => {
             const active = canvas.getActiveObject();
             if(active) {
                 active.scale(e.target.value / 50); // Escala relativa
                 canvas.renderAll();
             }
        });


        // --- 5. LGICA DE EXPORTACIN (LA MAGIA OCULTA) ---

        function startExport() {
            if(!videoEl.src) return;

            // 1. Mostrar Overlay de "Procesando"
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('progressBar').style.width = '0%';
            isProcessing = true;

            // 2. Preparar grabaci贸n oculta
            canvas.discardActiveObject(); // Quitar selecciones
            canvas.renderAll();
            
            const stream = canvas.getElement().captureStream(30); // 30 FPS
            
            // Audio Logic
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaElementSource(videoEl);
            const dest = audioCtx.createMediaStreamDestination();
            source.connect(dest);
            source.connect(audioCtx.destination); // Oir mientras procesa (opcional)
            
            const combinedStream = new MediaStream([
                ...stream.getVideoTracks(),
                ...dest.stream.getAudioTracks()
            ]);

            const recorder = new MediaRecorder(combinedStream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            
            recorder.onstop = () => {
                // Fin del proceso
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'video-editado.webm';
                a.click();
                
                // Restaurar UI
                isProcessing = false;
                document.getElementById('loadingOverlay').classList.add('hidden');
                
                // Reiniciar video para que el usuario pueda seguir editando si quiere
                videoEl.currentTime = 0; 
                // Reiniciar loop visual
                fabric.util.requestAnimFrame(function render() {
                    canvas.renderAll();
                    if(!isProcessing) fabric.util.requestAnimFrame(render);
                });
            };

            // 3. Ejecutar "Render" (Reproducir video mientras se graba)
            videoEl.currentTime = 0;
            videoEl.play();
            recorder.start();

            // Sincronizar barra de progreso
            const duration = videoEl.duration;
            const updateProgress = setInterval(() => {
                if(videoEl.paused || videoEl.ended) {
                    clearInterval(updateProgress);
                } else {
                    const pct = Math.round((videoEl.currentTime / duration) * 100);
                    document.getElementById('progressBar').style.width = pct + '%';
                    document.getElementById('progressText').innerText = pct + '%';
                }
            }, 100);

            // Detener al finalizar el video
            videoEl.onended = () => {
                recorder.stop();
                videoEl.onended = null; // Limpiar evento
            };
        }

    </script>
</body>
</html>
