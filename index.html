<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor Video M贸vil Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Ajustes cr铆ticos para m贸vil */
        body { 
            overscroll-behavior: none; 
            touch-action: none; 
            background-color: #000;
        }
        
        /* Usamos dvh para evitar problemas con la barra de direcci贸n del navegador m贸vil */
        .app-container {
            height: 100dvh; 
            display: flex;
            flex-direction: column;
        }

        .canvas-wrapper {
            flex: 1;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        /* Botones optimizados para pulgares */
        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            color: #9ca3af;
            font-size: 0.7rem;
            transition: color 0.2s;
        }
        .tool-btn:active { color: #818cf8; transform: scale(0.95); }
        .tool-btn i { font-size: 1.4rem; margin-bottom: 4px; }

        /* Overlay de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-white font-['Roboto']">

    <div class="app-container">
        
        <header class="h-14 bg-gray-900 flex justify-between items-center px-4 border-b border-gray-800 z-20 shrink-0">
            <div class="font-bold text-lg text-white">Video<span class="text-indigo-500">Maker</span></div>
            
            <label id="uploadBtn" class="bg-gray-800 border border-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 cursor-pointer active:bg-gray-700">
                <i class="fa-solid fa-plus"></i> Nuevo
                <input type="file" id="videoInput" class="hidden" accept="video/mp4,video/webm">
            </label>

            <button id="saveBtn" onclick="exportVideo()" class="bg-indigo-600 px-4 py-1.5 rounded-lg text-xs font-bold hidden flex items-center gap-2">
                <i class="fa-solid fa-download"></i> Guardar
            </button>
        </header>

        <main class="canvas-wrapper relative">
            
            <div id="welcome" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10 bg-gray-900">
                <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <i class="fa-solid fa-video text-3xl text-indigo-500"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">Editor de Video M贸vil</h2>
                <p class="text-gray-400 text-sm max-w-xs">Toca "Nuevo" arriba para subir un video (5s - 40s) y comenzar.</p>
            </div>

            <canvas id="c"></canvas>
            
            <video id="sourceVideo" class="hidden" playsinline webkit-playsinline crossorigin="anonymous"></video>
        </main>

        <footer id="footerTools" class="h-20 bg-gray-900 border-t border-gray-800 grid grid-cols-4 gap-1 shrink-0 hidden">
            <button onclick="addText()" class="tool-btn">
                <i class="fa-solid fa-font"></i> Texto
            </button>
            <button onclick="addTemplate()" class="tool-btn">
                <i class="fa-solid fa-layer-group"></i> Plantilla
            </button>
            <button onclick="addEmoji()" class="tool-btn">
                <i class="fa-regular fa-face-smile"></i> Emoji
            </button>
            <button onclick="deleteActive()" class="tool-btn text-red-400">
                <i class="fa-solid fa-trash"></i> Borrar
            </button>
        </footer>
    </div>

    <div id="editPanel" class="fixed bottom-0 left-0 right-0 bg-gray-800 p-5 rounded-t-3xl transform translate-y-full transition-transform duration-300 z-50 shadow-2xl pb-8">
        <div class="flex justify-between items-center mb-4">
            <span class="font-bold text-sm text-gray-300 uppercase tracking-wider">Editar Estilo</span>
            <button onclick="closeEditPanel()" class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="text-xs text-gray-500 mb-2 block">Color</label>
                <div class="flex gap-2 overflow-x-auto pb-2">
                    <div onclick="setColor('#ffffff')" class="w-8 h-8 rounded-full bg-white border-2 border-gray-600 flex-shrink-0 cursor-pointer"></div>
                    <div onclick="setColor('#000000')" class="w-8 h-8 rounded-full bg-black border-2 border-gray-600 flex-shrink-0 cursor-pointer"></div>
                    <div onclick="setColor('#ef4444')" class="w-8 h-8 rounded-full bg-red-500 flex-shrink-0 cursor-pointer"></div>
                    <div onclick="setColor('#3b82f6')" class="w-8 h-8 rounded-full bg-blue-500 flex-shrink-0 cursor-pointer"></div>
                    <div onclick="setColor('#facc15')" class="w-8 h-8 rounded-full bg-yellow-400 flex-shrink-0 cursor-pointer"></div>
                    <input type="color" id="customColor" class="w-8 h-8 p-0 border-0 rounded-full overflow-hidden flex-shrink-0">
                </div>
            </div>
            
            <div>
                <label class="text-xs text-gray-500 mb-2 block">Tama帽o</label>
                <input type="range" id="sizeSlider" min="0.5" max="2" step="0.1" value="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </div>

    <div id="processingOverlay" class="fixed inset-0 bg-black/90 z-[60] hidden flex-col items-center justify-center text-center px-6">
        <div class="loader mb-4"></div>
        <h3 class="text-xl font-bold text-white">Generando Video...</h3>
        <p class="text-sm text-gray-400 mt-2">Espera a que termine. No cierres esto.</p>
        <div class="w-full max-w-xs bg-gray-800 h-2 rounded-full mt-6 overflow-hidden">
            <div id="progressBar" class="bg-indigo-500 h-full w-0 transition-all duration-200"></div>
        </div>
        <p id="progressText" class="text-xs text-gray-500 mt-2">0%</p>
    </div>

    <script>
        // --- INICIALIZACIN ---
        const canvas = new fabric.Canvas('c', { selection: false });
        const videoEl = document.getElementById('sourceVideo');
        const editPanel = document.getElementById('editPanel');
        let fabricVideoImg; // Referencia al objeto de video en Canvas
        let renderLoopId; // ID del loop de animaci贸n

        // Ajustar tama帽o del canvas al iniciar
        function resizeCanvas() {
            const wrapper = document.querySelector('.canvas-wrapper');
            canvas.setWidth(wrapper.clientWidth);
            canvas.setHeight(wrapper.clientHeight);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- 1. CARGA DE VIDEO ROBUSTA ---
        document.getElementById('videoInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            videoEl.src = url;
            
            // Forzamos mute inicial para evitar bloqueo de autoplay
            videoEl.muted = true; 

            // Esperar a que el video tenga datos suficientes
            videoEl.onloadedmetadata = function() {
                if (videoEl.duration < 5 || videoEl.duration > 40) {
                    alert("锔 El video debe durar entre 5 y 40 segundos.");
                    return;
                }

                // Ajustar UI
                document.getElementById('welcome').classList.add('hidden');
                document.getElementById('footerTools').classList.remove('hidden');
                document.getElementById('footerTools').classList.add('grid');
                document.getElementById('saveBtn').classList.remove('hidden');
                document.getElementById('uploadBtn').innerHTML = '<i class="fa-solid fa-repeat"></i> Cambiar';

                setupCanvasForVideo();
            };
        });

        function setupCanvasForVideo() {
            // Calcular dimensiones para 'contain' (que se vea todo el video)
            const wrapperW = document.querySelector('.canvas-wrapper').clientWidth;
            const wrapperH = document.querySelector('.canvas-wrapper').clientHeight;
            const videoRatio = videoEl.videoWidth / videoEl.videoHeight;
            
            let finalW = wrapperW;
            let finalH = wrapperW / videoRatio;

            if (finalH > wrapperH) {
                finalH = wrapperH;
                finalW = wrapperH * videoRatio;
            }

            // Redimensionar canvas al tama帽o exacto del video visual
            canvas.setWidth(finalW);
            canvas.setHeight(finalH);

            // Crear objeto de Fabric
            fabricVideoImg = new fabric.Image(videoEl, {
                left: 0,
                top: 0,
                scaleX: finalW / videoEl.videoWidth,
                scaleY: finalH / videoEl.videoHeight,
                selectable: false,
                evented: false,
                objectCaching: false // IMPORTANTE para video
            });

            canvas.clear();
            canvas.add(fabricVideoImg);
            
            // Reproducir video (en bucle para editar)
            videoEl.loop = true;
            videoEl.play().then(() => {
                // Iniciar el Render Loop
                startRenderLoop();
            }).catch(e => console.error("Error autoplay:", e));
        }

        // --- 2. EL SECRETO PARA QUE NO SE VEA NEGRO: RENDER LOOP ---
        function startRenderLoop() {
            if (renderLoopId) cancelAnimationFrame(renderLoopId);
            
            function render() {
                // Solo renderizar si el video est谩 listo
                if (videoEl.readyState >= 2) { 
                    canvas.renderAll(); 
                }
                renderLoopId = requestAnimationFrame(render);
            }
            render();
        }

        // --- 3. HERRAMIENTAS DE EDICIN ---
        function addText() {
            const text = new fabric.IText('Toca 2 veces', {
                left: canvas.width / 2, top: canvas.height / 2,
                originX: 'center', originY: 'center',
                fontFamily: 'Montserrat', fontSize: 30, fill: '#fff',
                fontWeight: 'bold',
                shadow: '0px 2px 4px rgba(0,0,0,0.8)'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function addTemplate() {
            const rect = new fabric.Rect({
                fill: '#ffffff', width: 200, height: 50, rx: 10, ry: 10,
                originX: 'center', originY: 'center'
            });
            const text = new fabric.IText('TITULO', {
                fontFamily: 'Montserrat', fontSize: 24, fill: '#000',
                originX: 'center', originY: 'center', fontWeight: 'bold'
            });
            const group = new fabric.Group([rect, text], {
                left: canvas.width / 2, top: canvas.height / 2
            });
            canvas.add(group);
            canvas.setActiveObject(group);
        }

        function addEmoji() {
            const emoji = new fabric.IText('', {
                fontSize: 50, left: canvas.width/2, top: canvas.height/2, originX:'center', originY:'center'
            });
            canvas.add(emoji);
        }

        function deleteActive() {
            const active = canvas.getActiveObject();
            if(active) canvas.remove(active);
            closeEditPanel();
        }

        // --- 4. PANEL DE EDICIN RESPONSIVO ---
        canvas.on('selection:created', openEditPanel);
        canvas.on('selection:updated', openEditPanel);
        canvas.on('selection:cleared', closeEditPanel);

        function openEditPanel() {
            editPanel.classList.remove('translate-y-full');
        }
        function closeEditPanel() {
            editPanel.classList.add('translate-y-full');
            canvas.discardActiveObject();
            canvas.renderAll();
        }

        function setColor(color) {
            const active = canvas.getActiveObject();
            if(!active) return;
            
            if(active.type === 'group') {
                active.getObjects().forEach(o => {
                    if(o.type === 'rect') o.set('fill', color);
                    if(o.type === 'i-text') o.set('fill', color === '#ffffff' ? '#000000' : '#ffffff');
                });
            } else {
                active.set('fill', color);
            }
            canvas.renderAll();
        }

        document.getElementById('customColor').addEventListener('input', (e) => setColor(e.target.value));
        
        document.getElementById('sizeSlider').addEventListener('input', (e) => {
            const active = canvas.getActiveObject();
            if(active) {
                active.scale(parseFloat(e.target.value));
                canvas.renderAll();
            }
        });

        // --- 5. EXPORTACIN (CORRECCIN DE PANTALLA NEGRA Y SONIDO) ---
        async function exportVideo() {
            // UI
            const overlay = document.getElementById('processingOverlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            canvas.discardActiveObject(); // Quitar cuadros de selecci贸n
            canvas.renderAll();

            // Preparar Video
            videoEl.pause();
            videoEl.currentTime = 0;
            videoEl.loop = false; // Importante para que se detenga al final
            videoEl.muted = false; // ACTIVAR SONIDO AHORA

            // Configurar Streams
            const canvasStream = canvas.getElement().captureStream(30); // 30 FPS
            
            // Captura de Audio Robusta
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            try {
                const source = audioCtx.createMediaElementSource(videoEl);
                source.connect(dest);
                source.connect(audioCtx.destination); // Para que el usuario lo escuche
            } catch(e) {
                // Si ya estaba conectado, ignorar error
            }

            const combinedStream = new MediaStream([
                ...canvasStream.getVideoTracks(),
                ...dest.stream.getAudioTracks()
            ]);

            const chunks = [];
            const recorder = new MediaRecorder(combinedStream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `video_editado_${Date.now()}.webm`;
                a.click();
                
                // Reset
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                videoEl.muted = true; // Mutear de nuevo
                videoEl.loop = true;
                videoEl.play();
                startRenderLoop(); // Reiniciar loop visual
            };

            // INICIAR GRABACIN
            recorder.start();
            try {
                await videoEl.play(); // Esperar a que el video realmente arranque
            } catch (err) {
                console.error("Error al reproducir para grabar:", err);
            }

            // Sincronizar Barra de Progreso
            const duration = videoEl.duration;
            const progressInterval = setInterval(() => {
                if (videoEl.paused || videoEl.ended) {
                    clearInterval(progressInterval);
                    if (recorder.state === 'recording') recorder.stop();
                } else {
                    const percent = Math.round((videoEl.currentTime / duration) * 100);
                    document.getElementById('progressBar').style.width = `${percent}%`;
                    document.getElementById('progressText').innerText = `${percent}%`;
                }
            }, 100);

            // Seguridad: Detener si llega al final
            videoEl.onended = () => {
                if (recorder.state === 'recording') recorder.stop();
            };
        }
    </script>
</body>
</html>
