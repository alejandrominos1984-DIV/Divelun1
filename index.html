<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Editor Pro Mobile</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { 
            overscroll-behavior: none; 
            touch-action: none; 
            background-color: #000;
            overflow: hidden; /* Evita scroll en toda la p치gina */
        }
        
        .app-container {
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* TRUCO IMPORTANTE:
           El video fuente NO debe tener display:none.
           Lo ponemos absoluto, con z-index bajo para que quede DETR츼S del canvas.
           As칤 el navegador sigue renderiz치ndolo.
        */
        #sourceVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 1px; /* Muy peque침o pero existe */
            height: 1px;
            opacity: 0.01; /* Casi invisible pero "visible" para el sistema */
            pointer-events: none;
            z-index: -1; 
        }

        .canvas-wrapper {
            flex: 1;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            color: #9ca3af;
            font-size: 0.65rem; /* Texto m치s peque침o para que quepa */
            transition: color 0.2s;
        }
        .tool-btn:active { color: #818cf8; transform: scale(0.90); }
        .tool-btn i { font-size: 1.2rem; margin-bottom: 4px; }

        /* Loader */
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-white font-['Roboto']">

    <div class="app-container">
        
        <header class="h-14 bg-gray-900 flex justify-between items-center px-4 border-b border-gray-800 z-20 shrink-0">
            <div class="font-bold text-base">Video<span class="text-indigo-500">Maker</span></div>
            
            <div class="flex gap-2">
                <label id="uploadBtn" class="bg-gray-800 border border-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 cursor-pointer active:bg-gray-700">
                    <i class="fa-solid fa-plus"></i> <span id="btnText">Video</span>
                    <input type="file" id="videoInput" class="hidden" accept="video/mp4,video/webm">
                </label>

                <button id="saveBtn" onclick="exportVideo()" class="bg-indigo-600 active:bg-indigo-700 px-4 py-1.5 rounded-lg text-xs font-bold hidden flex items-center gap-2 transition-colors">
                    <i class="fa-solid fa-download"></i> Guardar
                </button>
            </div>
        </header>

        <main class="canvas-wrapper">
            
            <div id="welcome" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10 bg-gray-900">
                <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4">
                    <i class="fa-solid fa-film text-2xl text-indigo-500"></i>
                </div>
                <h2 class="text-lg font-bold mb-1">Editor M칩vil</h2>
                <p class="text-gray-400 text-xs">Sube un video (5s - 40s)</p>
            </div>

            <canvas id="c"></canvas>
            
            <video id="sourceVideo" playsinline webkit-playsinline crossorigin="anonymous"></video>
        </main>

        <footer id="footerTools" class="h-20 bg-gray-900 border-t border-gray-800 grid grid-cols-4 gap-1 shrink-0 hidden pb-safe">
            <button onclick="addText()" class="tool-btn">
                <i class="fa-solid fa-font"></i> Texto
            </button>
            <button onclick="addTemplate()" class="tool-btn">
                <i class="fa-solid fa-square-poll-horizontal"></i> Plantilla
            </button>
            <button onclick="addEmoji()" class="tool-btn">
                <i class="fa-regular fa-face-smile"></i> Emoji
            </button>
            <button onclick="deleteActive()" class="tool-btn text-red-400">
                <i class="fa-solid fa-trash"></i> Borrar
            </button>
        </footer>
    </div>

    <div id="editPanel" class="fixed bottom-0 left-0 right-0 bg-gray-800 p-5 rounded-t-3xl transform translate-y-full transition-transform duration-300 z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] pb-10">
        <div class="flex justify-between items-center mb-4">
            <span class="font-bold text-xs text-gray-400 uppercase tracking-widest">Estilo</span>
            <button onclick="closeEditPanel()" class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center active:scale-90 transition"><i class="fa-solid fa-times"></i></button>
        </div>
        
        <div class="space-y-4">
            <div>
                <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                    <div onclick="setColor('#ffffff')" class="w-10 h-10 rounded-full bg-white border-2 border-gray-600 shrink-0 shadow-sm"></div>
                    <div onclick="setColor('#000000')" class="w-10 h-10 rounded-full bg-black border-2 border-gray-600 shrink-0 shadow-sm"></div>
                    <div onclick="setColor('#ef4444')" class="w-10 h-10 rounded-full bg-red-500 shrink-0 shadow-sm"></div>
                    <div onclick="setColor('#3b82f6')" class="w-10 h-10 rounded-full bg-blue-500 shrink-0 shadow-sm"></div>
                    <div onclick="setColor('#fbbf24')" class="w-10 h-10 rounded-full bg-yellow-400 shrink-0 shadow-sm"></div>
                    <div onclick="setColor('#10b981')" class="w-10 h-10 rounded-full bg-emerald-500 shrink-0 shadow-sm"></div>
                </div>
            </div>
            
            <div class="bg-gray-700 rounded-xl p-3 flex items-center gap-3">
                <i class="fa-solid fa-text-height text-gray-400 text-xs"></i>
                <input type="range" id="sizeSlider" min="0.5" max="2.5" step="0.1" value="1" class="w-full h-1 bg-gray-500 rounded-lg appearance-none cursor-pointer">
                <i class="fa-solid fa-text-height text-white text-lg"></i>
            </div>
        </div>
    </div>

    <div id="processingOverlay" class="fixed inset-0 bg-black/95 z-[60] hidden flex-col items-center justify-center text-center px-8">
        <div class="loader mb-6"></div>
        <h3 class="text-xl font-bold text-white mb-2">Exportando Video...</h3>
        <p class="text-xs text-gray-400 mb-6">Por favor espera y no cierres la pantalla.</p>
        
        <div class="w-full bg-gray-800 h-3 rounded-full overflow-hidden border border-gray-700">
            <div id="progressBar" class="bg-gradient-to-r from-indigo-600 to-purple-600 h-full w-0 transition-all duration-200"></div>
        </div>
        <p id="progressText" class="text-xs text-gray-400 mt-3 font-mono">0%</p>
    </div>

    <script>
        // --- 1. SETUP INICIAL ---
        const canvas = new fabric.Canvas('c', { 
            selection: false,
            preserveObjectStacking: true 
        });
        const videoEl = document.getElementById('sourceVideo');
        const editPanel = document.getElementById('editPanel');
        let fabricVideoImg; 
        let isExporting = false;

        // --- 2. CARGA DE VIDEO ---
        document.getElementById('videoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            videoEl.src = url;
            videoEl.muted = true; // Necesario para autoplay inicial
            
            videoEl.onloadedmetadata = function() {
                // Validaci칩n tiempo
                if (videoEl.duration < 5 || videoEl.duration > 40) {
                    alert("丘멆잺 El video debe durar entre 5 y 40 segundos.");
                    return;
                }

                // UI
                document.getElementById('welcome').classList.add('hidden');
                document.getElementById('footerTools').classList.remove('hidden');
                document.getElementById('footerTools').classList.add('grid');
                document.getElementById('saveBtn').classList.remove('hidden');
                document.getElementById('btnText').innerText = "Cambiar";
                
                setupCanvas();
            };
        });

        function setupCanvas() {
            // Ajuste al tama침o del contenedor
            const wrapper = document.querySelector('.canvas-wrapper');
            const w = wrapper.clientWidth;
            const h = wrapper.clientHeight;
            
            // Calculo para "Contain" (que se vea todo el video)
            const ratio = videoEl.videoWidth / videoEl.videoHeight;
            let finalW = w;
            let finalH = w / ratio;
            
            if(finalH > h) {
                finalH = h;
                finalW = h * ratio;
            }

            canvas.setWidth(finalW);
            canvas.setHeight(finalH);

            // Crear objeto Fabric Video
            fabricVideoImg = new fabric.Image(videoEl, {
                left: 0, top: 0,
                scaleX: finalW / videoEl.videoWidth,
                scaleY: finalH / videoEl.videoHeight,
                selectable: false,
                evented: false,
                objectCaching: false // CRUCIAL: No cachear imagen est치tica
            });

            canvas.clear();
            canvas.add(fabricVideoImg);
            
            // Reproducir para editar
            videoEl.loop = true;
            videoEl.play();
            
            // Render Loop Constante
            fabric.util.requestAnimFrame(function render() {
                if (videoEl.readyState === 4) { // HAVE_ENOUGH_DATA
                    canvas.renderAll();
                }
                if (!isExporting) fabric.util.requestAnimFrame(render);
            });
        }

        // --- 3. HERRAMIENTAS ---
        function addText() {
            const t = new fabric.IText('Toca 2 veces', {
                left: canvas.width/2, top: canvas.height/2,
                originX: 'center', originY: 'center',
                fontFamily: 'Montserrat', fontSize: 30, fill: '#fff',
                fontWeight: 'bold', shadow: '0 2px 5px rgba(0,0,0,0.8)'
            });
            canvas.add(t);
            canvas.setActiveObject(t);
        }

        function addTemplate() {
            const rect = new fabric.Rect({
                fill: '#fff', width: 220, height: 50, rx: 12, ry: 12,
                originX: 'center', originY: 'center', shadow: '0 4px 10px rgba(0,0,0,0.3)'
            });
            const t = new fabric.IText('TU TEXTO', {
                fontFamily: 'Montserrat', fontSize: 20, fill: '#000',
                originX: 'center', originY: 'center', fontWeight: 'bold'
            });
            const g = new fabric.Group([rect, t], {
                left: canvas.width/2, top: canvas.height/2
            });
            canvas.add(g);
            canvas.setActiveObject(g);
        }

        function addEmoji() {
            const e = new fabric.IText('游댠', {
                fontSize: 60, left: canvas.width/2, top: canvas.height/2,
                originX: 'center', originY: 'center', selectable: true
            });
            canvas.add(e);
        }

        function deleteActive() {
            const a = canvas.getActiveObject();
            if(a) canvas.remove(a);
            closeEditPanel();
        }

        // --- 4. PANEL Y COLORES ---
        canvas.on('selection:created', () => editPanel.classList.remove('translate-y-full'));
        canvas.on('selection:updated', () => editPanel.classList.remove('translate-y-full'));
        canvas.on('selection:cleared', () => editPanel.classList.add('translate-y-full'));
        
        function closeEditPanel() {
            editPanel.classList.add('translate-y-full');
            canvas.discardActiveObject();
            canvas.renderAll();
        }

        function setColor(hex) {
            const active = canvas.getActiveObject();
            if(!active) return;
            if(active.type === 'group') {
                active.getObjects().forEach(o => {
                    if(o.type === 'rect') o.set('fill', hex);
                    // Contraste autom치tico texto
                    if(o.type === 'i-text') o.set('fill', hex === '#ffffff' ? '#000000' : '#ffffff');
                });
            } else {
                active.set('fill', hex);
            }
            canvas.renderAll();
        }

        document.getElementById('sizeSlider').addEventListener('input', (e) => {
            const active = canvas.getActiveObject();
            if(active) { active.scale(parseFloat(e.target.value)); canvas.renderAll(); }
        });

        // --- 5. EXPORTACI칍N ROBUSTA (FIX PANTALLA NEGRA) ---
        async function exportVideo() {
            isExporting = true;
            
            // 1. Preparar UI
            document.getElementById('processingOverlay').classList.remove('hidden');
            document.getElementById('processingOverlay').classList.add('flex');
            canvas.discardActiveObject();
            canvas.renderAll();

            // 2. Resetear Video
            videoEl.pause();
            videoEl.currentTime = 0;
            videoEl.loop = false;
            videoEl.muted = false; // IMPORTANTE: Activar sonido para grabar

            // 3. Capturar Streams
            const canvasStream = canvas.getElement().captureStream(30); // 30 FPS
            
            // Audio context para mezclar sonido del video
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            try {
                // Conectar video al stream de destino
                const source = audioCtx.createMediaElementSource(videoEl);
                source.connect(dest);
                source.connect(audioCtx.destination); // O칤r mientras graba
            } catch (e) { console.log("Audio node already connected"); }

            const combinedStream = new MediaStream([
                ...canvasStream.getVideoTracks(),
                ...dest.stream.getAudioTracks()
            ]);

            // 4. Iniciar Grabadora
            const chunks = [];
            const recorder = new MediaRecorder(combinedStream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                // Descargar
                const a = document.createElement('a');
                a.href = url;
                a.download = `video-editado-${Date.now()}.webm`;
                document.body.appendChild(a);
                a.click();
                
                // Limpieza
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    document.getElementById('processingOverlay').classList.add('hidden');
                    document.getElementById('processingOverlay').classList.remove('flex');
                    isExporting = false;
                    
                    // Restaurar estado editor
                    videoEl.muted = true;
                    videoEl.loop = true;
                    videoEl.play();
                    
                    // Reiniciar loop visual
                    fabric.util.requestAnimFrame(function render() {
                        if (videoEl.readyState === 4) canvas.renderAll();
                        if (!isExporting) fabric.util.requestAnimFrame(render);
                    });
                }, 500);
            };

            // 5. El Bucle de Grabaci칩n "MANUAL"
            // Forzamos el renderizado en cada evento de tiempo del video
            // Esto asegura que si el video avanza, el canvas se pinta.
            videoEl.ontimeupdate = function() {
                canvas.renderAll();
            };

            recorder.start();
            try {
                await videoEl.play();
            } catch(e) { console.error(e); }

            // Barra de progreso
            const dur = videoEl.duration;
            const intv = setInterval(() => {
                if(videoEl.paused || videoEl.ended) {
                    clearInterval(intv);
                    if(recorder.state === 'recording') recorder.stop();
                } else {
                    const pct = Math.round((videoEl.currentTime / dur) * 100);
                    document.getElementById('progressBar').style.width = pct + '%';
                    document.getElementById('progressText').innerText = pct + '%';
                }
            }, 100);
            
            videoEl.onended = () => {
                if(recorder.state === 'recording') recorder.stop();
            };
        }
    </script>
</body>
</html>
