// ##################################################################
// ###############      SECCI√ìN DE CONFIGURACI√ìN      ###############
// ##################################################################

// TU URL DE GOOGLE APPS SCRIPT (¬°ACTUALIZADA!)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwLWni5rAuOc8dEgQ4ILfpKSX-lKcTtNE762e5DIUMn0Fbdjf20tbKKRXC-fj3CPR5uJA/exec";
const STRIPE_LINK = "https://buy.stripe.com/test_aFa14p69Vgk53hjclXaZi01";

// Tu URL de GitHub Pages (ajusta seg√∫n tu repositorio)
// Si es local, d√©jalo como est√°; si ya est√° en GitHub Pages, cambia por tu URL real
const GITHUB_PAGES_URL = window.location.origin;

// ##################################################################
// ###############      FIN DE LA CONFIGURACI√ìN       ###############
// ##################################################################

/**
 * Sistema de Enrutamiento
 */
const router = {
    navigate: (viewId) => {
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.add('hidden');
            el.classList.remove('flex');
        });

        const target = document.getElementById(`view-${viewId}`);
        if (target) {
            target.classList.remove('hidden');
            if(viewId === 'welcome') target.classList.add('flex');
            lucide.createIcons();
            window.scrollTo(0, 0);
        }
    }
};

// Clase para manejar llamadas a la API - CORREGIDA PARA CORS
class APIClient {
    constructor(baseUrl) {
        this.baseUrl = baseUrl;
    }

    async request(data) {
        try {
            // Construir URL con par√°metro de origen para CORS
            const url = new URL(this.baseUrl);
            url.searchParams.append('origin', GITHUB_PAGES_URL);
            
            // IMPORTANTE: Usar fetch con modo 'cors' y headers correctos
            const response = await fetch(url.toString(), {
                method: 'POST',
                mode: 'cors', // Cambiado de 'no-cors' a 'cors'
                cache: 'no-cache',
                redirect: 'follow', // Seguir redirecciones si las hay
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            // Verificar si la respuesta es OK
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Parsear la respuesta como JSON
            const result = await response.json();
            return result;
            
        } catch (error) {
            console.error('API Request Error:', error);
            
            // Intentar m√©todo alternativo con text/plain para evitar preflight
            if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
                console.warn('CORS error, trying alternative method...');
                return await this.requestAlternative(data);
            }
            
            throw error;
        }
    }

    // M√©todo alternativo usando text/plain para evitar preflight OPTIONS
    async requestAlternative(data) {
        try {
            const url = new URL(this.baseUrl);
            url.searchParams.append('origin', GITHUB_PAGES_URL);
            
            // Usar text/plain para evitar preflight CORS
            const response = await fetch(url.toString(), {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const text = await response.text();
            return JSON.parse(text);
            
        } catch (error) {
            console.error('Alternative request failed:', error);
            
            // √öltimo recurso: usar fetch sin headers espec√≠ficos
            try {
                const url = new URL(this.baseUrl);
                url.searchParams.append('origin', GITHUB_PAGES_URL);
                
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    body: JSON.stringify(data)
                    // No headers para evitar preflight
                });

                if (response.ok) {
                    const text = await response.text();
                    return JSON.parse(text);
                }
            } catch (finalError) {
                console.error('Final attempt failed:', finalError);
                throw new Error('No se pudo conectar con el servidor. Verifica tu conexi√≥n.');
            }
        }
    }
}

// Inicializar cliente API
const apiClient = new APIClient(SCRIPT_URL);

const app = {
    state: {
        user: null,
        isLoading: false,
        api: apiClient
    },

    // Inicializaci√≥n
    init: () => {
        lucide.createIcons();
        app.checkSession();
        
        // Verificar conexi√≥n con API
        app.testAPI();
    },

    // Test de conexi√≥n con API
    async testAPI() {
        try {
            const url = new URL(SCRIPT_URL);
            url.searchParams.append('origin', GITHUB_PAGES_URL);
            
            const response = await fetch(url.toString());
            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ API conectada:', data);
                return true;
            }
        } catch (error) {
            console.warn('‚ùå API test failed:', error);
            
            // Intentar sin CORS
            try {
                const response = await fetch(SCRIPT_URL);
                if (response.ok) {
                    console.log('‚ö†Ô∏è  API responde pero puede haber CORS');
                }
            } catch (e) {
                console.error('‚ùå No se puede conectar a la API');
            }
            
            return false;
        }
    },

    // Verificar Sesi√≥n Local
    checkSession: () => {
        const storedUser = localStorage.getItem('aura_user');
        if (storedUser) {
            try {
                app.state.user = JSON.parse(storedUser);
                // Redirecci√≥n basada en el status guardado localmente
                if (app.state.user.status === 'PAID') {
                    app.updateDashboardUI();
                    router.navigate('dashboard');
                } else {
                    router.navigate('paywall');
                }
            } catch (e) {
                console.error("Error al leer sesi√≥n local:", e);
                localStorage.removeItem('aura_user');
                router.navigate('welcome');
            }
        } else {
            router.navigate('welcome');
        }
    },

    // Manejo de Registro (Crea nuevos usuarios) - CORREGIDO
    handleRegister: async (e) => {
        e.preventDefault();
        app.toggleLoading(true, 'btn-register');

        const form = e.target;
        const email = form.email.value.trim().toLowerCase();
        const password = form.password.value;
        
        // Validaci√≥n b√°sica
        if (!email.includes('@') || !email.includes('.')) {
            alert('Por favor ingresa un email v√°lido');
            app.toggleLoading(false, 'btn-register', 'Continuar');
            return;
        }
        
        if (password.length < 6) {
            alert('La contrase√±a debe tener al menos 6 caracteres');
            app.toggleLoading(false, 'btn-register', 'Continuar');
            return;
        }
        
        const userData = {
            action: 'register',
            email: email,
            password: password,
            date: new Date().toISOString(),
            source: 'aura_web_app'
        };

        try {
            const data = await app.state.api.request(userData);

            if (data.success) {
                // Usuario creado exitosamente
                const newUser = { 
                    email: email, 
                    status: data.user?.status || 'PENDING', 
                    name: email.split('@')[0],
                    registerDate: new Date().toISOString()
                };
                
                localStorage.setItem('aura_user', JSON.stringify(newUser));
                app.state.user = newUser;
                
                // Mostrar mensaje de √©xito
                alert("‚úÖ ¬°Registro exitoso! Tu cuenta ha sido creada.");
                router.navigate('paywall');
                
            } else {
                // Error del backend
                alert(`‚ùå ${data.message || "Error al registrar. Verifica si el usuario ya existe."}`);
            }

        } catch (error) {
            console.error("Error Registro:", error);
            
            // Mensaje espec√≠fico seg√∫n el error
            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                alert("üåê Error de conexi√≥n. Verifica tu internet e intenta de nuevo.");
            } else if (error.message.includes('CORS')) {
                alert("‚ö†Ô∏è  Error de seguridad del navegador. Intenta desde otro navegador o actualiza esta p√°gina.");
            } else {
                alert("‚ùå Error inesperado: " + error.message);
            }
            
        } finally {
            app.toggleLoading(false, 'btn-register', 'Continuar');
        }
    },

    // Manejo de Login - CORREGIDO
    handleLogin: async (e) => {
        e.preventDefault();
        app.toggleLoading(true, 'btn-login');

        const form = e.target;
        const email = form.email.value.trim().toLowerCase();
        const password = form.password.value;

        // Validaci√≥n b√°sica
        if (!email || !password) {
            alert('Por favor completa todos los campos');
            app.toggleLoading(false, 'btn-login', 'Entrar');
            return;
        }

        const loginData = {
            action: 'login',
            email: email,
            password: password,
            timestamp: new Date().toISOString()
        };

        try {
            const data = await app.state.api.request(loginData);

            if (data.success) {
                // Login exitoso
                const status = data.user?.status || (data.hasPaid ? 'PAID' : 'PENDING');
                
                const loggedUser = { 
                    email: email, 
                    status: status,
                    name: email.split('@')[0],
                    loginCount: data.user?.loginCount || 1,
                    lastLogin: new Date().toISOString()
                };

                localStorage.setItem('aura_user', JSON.stringify(loggedUser));
                app.state.user = loggedUser;
                
                app.updateDashboardUI();
                
                // REDIRECCI√ìN BASADA EN ESTADO
                if(status === 'PAID') {
                    alert(`‚úÖ Bienvenido de vuelta, ${loggedUser.name}!`);
                    router.navigate('dashboard');
                } else {
                    alert(`‚úÖ Login exitoso. Completa tu suscripci√≥n para acceder a todo el contenido.`);
                    router.navigate('paywall');
                }
            } else {
                // Fallo de autenticaci√≥n
                alert("‚ùå Email o contrase√±a incorrectos.");
            }

        } catch (error) {
            console.error("Error Login:", error);
            
            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                alert("üåê Error de conexi√≥n. Verifica tu internet.");
            } else {
                alert("‚ùå Error de conexi√≥n con el servidor. Intenta m√°s tarde.");
            }
            
        } finally {
            app.toggleLoading(false, 'btn-login', 'Entrar');
        }
    },

    // Abrir Stripe
    openStripe: () => {
        window.open(STRIPE_LINK, '_blank', 'noopener,noreferrer');
        
        // Opcional: Guardar que el usuario hizo clic en Stripe
        if (app.state.user) {
            localStorage.setItem('stripe_clicked', 'true');
        }
    },

    // Confirmar Pago - CORREGIDO
    confirmPayment: async () => {
        if(!app.state.user) {
            alert("‚ö†Ô∏è Primero debes iniciar sesi√≥n.");
            router.navigate('login');
            return;
        }
        
        if(confirm("¬øConfirmas que has realizado el pago de tu membres√≠a AURA ELITE?")) {
            const btn = document.querySelector('button[onclick*="confirmPayment"]');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = 'Confirmando...';
            }
            
            try {
                const data = await app.state.api.request({
                    action: 'payment_confirmation',
                    email: app.state.user.email,
                    confirmation_time: new Date().toISOString()
                });

                if (data.success) {
                    // Actualizar estado local
                    app.state.user.status = 'PAID';
                    app.state.user.paymentDate = new Date().toISOString();
                    localStorage.setItem('aura_user', JSON.stringify(app.state.user));
                    
                    app.updateDashboardUI();
                    alert("üéâ ¬°Pago confirmado! Ahora tienes acceso completo a AURA ELITE.");
                    router.navigate('dashboard');
                } else {
                    alert("‚ö†Ô∏è " + (data.message || "No se pudo confirmar el pago. Contacta al soporte."));
                }
            } catch (error) {
                console.error("Error confirmando pago:", error);
                alert("‚ùå Error de conexi√≥n al confirmar el pago.");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Ya realic√© mi pago';
                }
            }
        }
    },

    // Recuperar Contrase√±a - CORREGIDO
    handleRecovery: async () => {
        const email = prompt("üìß Ingresa tu email para recuperar la contrase√±a:");
        if(email && email.includes('@')) {
            try {
                const data = await app.state.api.request({ 
                    action: 'reset_password', 
                    email: email.trim().toLowerCase()
                });
                
                alert(data.message || "üì® Si el correo existe, recibir√°s instrucciones en tu email.");
            } catch (error) {
                alert("‚ö†Ô∏è Error al procesar la solicitud. Intenta m√°s tarde.");
            }
        } else if(email) {
            alert("‚ùå Por favor ingresa un email v√°lido.");
        }
    },

    // Log de Entrenamiento - CORREGIDO
    logWorkout: async () => {
        if(!app.state.user) {
            alert("‚ö†Ô∏è Primero debes iniciar sesi√≥n.");
            return;
        }
        
        if(!confirm("¬øRegistrar entrenamiento de hoy? üèãÔ∏è‚Äç‚ôÇÔ∏è")) return;

        try {
            const data = await app.state.api.request({
                action: 'log_workout',
                email: app.state.user.email,
                date: new Date().toISOString(),
                workout_type: 'general',
                duration_minutes: 60
            });
            
            if(data.success) {
                alert("‚úÖ ¬°Entrenamiento registrado! Buen trabajo. üéØ\n" + 
                      (data.workout ? `Tipo: ${data.workout.type}` : ''));
            } else {
                alert("‚ö†Ô∏è Hubo un problema al guardar el entrenamiento.");
            }
        } catch (error) {
            console.error(error);
            alert("üåê Error de conexi√≥n al guardar. Tu entrenamiento se guardar√° localmente.");
            
            // Guardar localmente como respaldo
            const workouts = JSON.parse(localStorage.getItem('aura_workouts') || '[]');
            workouts.push({
                email: app.state.user.email,
                date: new Date().toISOString(),
                saved_locally: true
            });
            localStorage.setItem('aura_workouts', JSON.stringify(workouts));
        }
    },

    // Cerrar Sesi√≥n
    logout: () => {
        if(confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n?")) {
            localStorage.removeItem('aura_user');
            app.state.user = null;
            router.navigate('welcome');
        }
    },

    // Utilidades UI
    toggleLoading: (isLoading, btnId, originalText = '') => {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        
        if(isLoading) {
            btn.dataset.original = btn.innerText;
            btn.disabled = true;
            btn.innerText = "‚è≥ Procesando...";
            btn.classList.add('opacity-70', 'cursor-not-allowed');
        } else {
            btn.disabled = false;
            btn.innerText = originalText || btn.dataset.original;
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
        }
    },

    updateDashboardUI: () => {
        const nameEl = document.getElementById('user-name');
        if(app.state.user && app.state.user.name) {
            // Capitalizar primera letra
            const capitalized = app.state.user.name.charAt(0).toUpperCase() + 
                              app.state.user.name.slice(1);
            nameEl.innerText = capitalized;
            
            // Actualizar fecha de √∫ltimo login si est√° disponible
            if (app.state.user.lastLogin) {
                const lastLogin = new Date(app.state.user.lastLogin);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                console.log('√öltimo login:', lastLogin.toLocaleDateString('es-ES', options));
            }
        }
    },
    
    // Funci√≥n adicional: Verificar estado de suscripci√≥n
    checkSubscriptionStatus: async () => {
        if (!app.state.user) return;
        
        try {
            const data = await app.state.api.request({
                action: 'check_status',
                email: app.state.user.email
            });
            
            if (data.success && data.user && data.user.status !== app.state.user.status) {
                // Actualizar estado si cambi√≥
                app.state.user.status = data.user.status;
                localStorage.setItem('aura_user', JSON.stringify(app.state.user));
                
                if (data.user.status === 'PAID' && window.location.hash.includes('paywall')) {
                    alert('üéâ ¬°Tu suscripci√≥n est√° activa! Redirigiendo al dashboard...');
                    router.navigate('dashboard');
                }
            }
        } catch (error) {
            // Silencioso, no mostrar error al usuario
            console.log('Status check:', error.message);
        }
    }
};

// Inicializar cuando el DOM est√© listo
window.addEventListener('DOMContentLoaded', app.init);

// Opcional: Verificar estado de suscripci√≥n cada 30 segundos si est√° en paywall
setInterval(() => {
    if (app.state.user && app.state.user.status === 'PENDING') {
        app.checkSubscriptionStatus();
    }
}, 30000);
